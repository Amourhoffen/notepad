<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EveXa Buddy Pad – Smart Notepad for Content-Based Study</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom CSS Variables for Theming (Dark and Light Mode) */
        :root {
            --primary-color: #6366f1; /* Indigo 500 */
            --secondary-color: #a78bfa; /* Violet 400 */
            --bg-dark: #1a202c; /* Dark charcoal */
            --bg-card: rgba(45, 55, 72, 0.4); /* Darker gray - semi-transparent for glassmorphism */
            --text-light: #e2e8f0; /* Light gray */
            --text-muted: #a0aec0; /* Muted gray */
            --border-color: rgba(74, 85, 104, 0.5); /* Semi-transparent border */
            --box-shadow: 0 18px 36px rgba(0, 0, 0, 0.5), 0 0 20px rgba(99, 102, 241, 0.2); /* Enhanced shadow */
            --success-color: #10b981; /* Emerald */
            --danger-color: #ef4444; /* Red */
            --input-bg-dark: rgba(45, 55, 72, 0.5); /* Slightly more opaque */
            --input-border-dark: rgba(74, 85, 104, 0.7); /* Slightly more opaque */
            /* Removed --focus-mode-bg */
        }

        body.light-mode {
            --primary-color: #4f46e5; /* Indigo 600 */
            --secondary-color: #8b5cf6; /* Violet 500 */
            --bg-dark: #f0f4f8; /* Light blue-gray */
            --bg-card: rgba(255, 255, 255, 0.7); /* White - semi-transparent for glassmorphism */
            --text-light: #2d3748; /* Dark gray */
            --text-muted: #718096; /* Medium gray */
            --border-color: rgba(203, 213, 224, 0.7); /* Light border - semi-transparent */
            --box-shadow: 0 18px 36px rgba(0, 0, 0, 0.2), 0 0 20px rgba(79, 70, 229, 0.1); /* Enhanced shadow */
            --success-color: #059669; /* Darker Emerald */
            --danger-color: #dc2626; /* Darker Red */
            --input-bg-dark: rgba(255, 255, 255, 0.8); /* Slightly more opaque */
            --input-border-dark: rgba(203, 213, 224, 0.9); /* Slightly more opaque */
            /* Removed --focus-mode-bg */
        }

        /* Base Body Styles */
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--bg-dark) 0%, #0d1117 100%);
            color: var(--text-light);
            transition: background 0.6s ease, color 0.6s ease;
            padding: 1.5rem; /* Increased base padding */
            box-sizing: border-box;
            line-height: 1.6; /* Improved readability */
        }

        /* Glassmorphism Effect */
        .glass-effect {
            backdrop-filter: blur(15px); /* Increased blur */
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid var(--border-color);
            box-shadow: var(--box-shadow);
            transition: box-shadow 0.3s ease, border-color 0.3s ease;
        }

        /* App Container */
        .app-container {
            background-color: var(--bg-card);
            padding: 2rem; /* More generous padding */
            border-radius: 20px; /* More rounded corners */
        }

        /* Header Styles */
        .header h1 {
            color: var(--primary-color);
            font-size: 2.8rem; /* Larger heading */
            font-weight: 800;
            text-shadow: 2px 2px 5px rgba(0,0,0,0.2);
        }

        /* Icon Buttons */
        .icon-button {
            background-color: transparent;
            color: var(--text-light);
            padding: 0.75rem; /* Larger touch target */
            border-radius: 9999px; /* Fully rounded */
            transition: background-color 0.2s ease, transform 0.2s ease, color 0.2s ease;
        }
        .icon-button:hover {
            background-color: rgba(255, 255, 255, 0.15); /* More prominent hover */
            transform: translateY(-2px);
        }
        body.light-mode .icon-button:hover {
            background-color: rgba(0, 0, 0, 0.08);
        }

        /* Input Fields */
        .input-field {
            background-color: var(--input-bg-dark);
            border: 1px solid var(--input-border-dark);
            color: var(--text-light);
            padding: 0.8rem; /* Increased padding */
            border-radius: 10px; /* Slightly more rounded */
            transition: border-color 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease;
        }
        .input-field::placeholder {
            color: var(--text-muted);
        }
        .input-field:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.4); /* Stronger focus ring */
            outline: none;
        }

        /* Primary Buttons */
        .button-primary {
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3); /* Slightly stronger border */
            padding: 0.8rem 1.8rem; /* More generous padding */
            border-radius: 12px; /* More rounded */
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .button-primary:hover {
            background: linear-gradient(45deg, var(--secondary-color), var(--primary-color));
            transform: translateY(-3px) scale(1.01); /* More pronounced lift */
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5), 0 0 20px var(--primary-color); /* Stronger shadow */
        }
        .button-primary:active {
            transform: translateY(0) scale(0.98);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3);
        }

        /* Secondary Buttons */
        .button-secondary {
            background-color: rgba(100, 100, 100, 0.4); /* Slightly more opaque */
            color: var(--text-light);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 0.8rem 1.8rem;
            border-radius: 12px;
            font-weight: 500;
            transition: background-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
        }
        .button-secondary:hover {
            background-color: rgba(120, 120, 120, 0.5);
            transform: translateY(-2px);
            box-shadow: 0 5px 12px rgba(0, 0, 0, 0.3);
        }
        .button-secondary:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        /* Card Styles */
        .card {
            background-color: var(--bg-card);
            border-radius: 15px;
            padding: 1.5rem; /* Consistent card padding */
        }

        /* Tag Pills */
        .tag-pill {
            background-color: rgba(99, 102, 241, 0.25); /* Slightly more opaque */
            color: var(--secondary-color);
            padding: 0.4rem 0.9rem; /* Adjusted padding */
            font-size: 0.85rem; /* Slightly larger font */
            border-radius: 9999px; /* Fully rounded */
            transition: background-color 0.2s ease, transform 0.1s ease;
        }
        .tag-pill:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .tag-pill.active-filter {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
        }

        /* Message Box */
        .message-box {
            background-color: var(--primary-color);
            color: white;
            padding: 1rem 1.5rem; /* More padding */
            border-radius: 12px;
            font-weight: 500;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
        }
        .message-box.error {
            background-color: var(--danger-color);
        }
        .message-box.success {
            background-color: var(--success-color);
        }

        /* Favorite Icon */
        .favorite-icon {
            color: #FFD700; /* Gold */
        }
        body.light-mode .favorite-icon {
            color: #DAA520; /* Goldenrod */
        }

        /* Removed Focus Mode Overlay CSS */
        /* .focus-mode-overlay {
            background-color: var(--focus-mode-bg);
            transition: opacity 0.3s ease, visibility 0.3s ease;
        } */
        /* .focus-mode-content { */
            /* padding: 40px; More padding */
            /* border-radius: 25px; More rounded */
            /* box-shadow: var(--box-shadow);
        }
        .focus-mode-content h3 { */
            /* font-size: 2em; Larger heading 
            font-weight: 700;
            color: var(--primary-color);
        } 
        .focus-mode-content p { */
            /* font-size: 1.15em; Slightly larger text
            line-height: 1.7; More comfortable line spacing */
        /* }
        .focus-mode-content .close-focus-mode {
            font-size: 1.8em; Larger close button
        } */

        /* Quiz Mode (Removed - keeping styles for reference if needed later) */
        /*
        .quiz-question {
            font-size: 1.6em;
            font-weight: 700;
        }
        .quiz-answer {
            font-size: 1.2em;
        }
        */

        /* Insights Panel */
        #insights-panel h3 {
            font-size: 1.8em;
            font-weight: 700;
        }
        #insights-panel p {
            font-size: 1.05em;
        }
        #insights-panel .insight-value {
            font-size: 1.1em;
        }

        /* Export Panel */
        #export-panel select, #export-panel input[type="text"] {
            padding: 12px; /* Larger input fields */
            border-radius: 10px;
            background-color: var(--input-bg-dark);
            border: 1px solid var(--input-border-dark);
        }

        /* Streak Counter */
        #streak-counter {
            font-size: 1.3em;
            font-weight: 700;
        }

        /* Tag Suggestions */
        .tag-suggestions {
            border-radius: 10px;
            box-shadow: var(--box-shadow);
        }
        .tag-suggestion-item {
            padding: 10px 15px; /* More padding */
            font-size: 0.95rem;
        }
        .tag-suggestion-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        body.light-mode .tag-suggestion-item:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        /* Title Overflow Fix */
        .break-words-overflow {
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        /* "See more" functionality */
        .toggle-title-btn {
            font-size: 0.85em; /* Slightly larger */
            margin-left: 0.75rem; /* More spacing */
        }

        /* Priority and Status styling */
        .priority-high { color: var(--danger-color); font-weight: 600; }
        .priority-medium { color: var(--warning-color); font-weight: 600; }
        .priority-low { color: var(--success-color); font-weight: 600; }

        .status-completed { color: var(--success-color); font-weight: 600; }
        .status-in-progress { color: var(--primary-color); font-weight: 600; }
        .status-to-do { color: var(--text-muted); font-weight: 600; }

        /* Responsive adjustments for overall layout */
        @media (max-width: 768px) {
            body {
                padding: 1rem; /* More compact padding on smaller screens */
            }
            .app-container {
                padding: 1.5rem; /* More compact padding for container */
            }
            .header {
                flex-direction: column;
                align-items: flex-start;
                margin-bottom: 1rem;
            }
            .header h1 {
                font-size: 2.2rem; /* Smaller heading on mobile */
                margin-bottom: 0.75rem;
            }
            .header > div { /* Button group */
                width: 100%;
                justify-content: space-around; /* Distribute buttons evenly */
                margin-top: 0.5rem;
            }
            .icon-button {
                padding: 0.6rem; /* Slightly larger touch target */
            }
            .button-primary, .button-secondary {
                padding: 0.75rem 1.25rem; /* Adjust button padding */
                font-size: 0.95rem;
            }
            .input-field {
                padding: 0.75rem; /* Adjust input field padding */
            }
            .content-item-notes-view .flex.items-center {
                flex-direction: column;
                align-items: flex-start;
            }
            .content-item-notes-view .flex.items-center h2 {
                margin-left: 0;
                margin-top: 0.5rem;
                font-size: 1.8rem;
            }
            /* Removed focus-mode-content responsive CSS */
            /* .focus-mode-content {
                padding: 25px;
            }
            .focus-mode-content h3 {
                font-size: 1.6em;
            }
            .focus-mode-content p {
                font-size: 1em;
            } */
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.8rem;
            }
            .button-primary, .button-secondary {
                padding: 0.6rem 1rem;
                font-size: 0.85rem;
            }
            .icon-button {
                padding: 0.5rem;
            }
            .app-container {
                padding: 1rem;
            }
            .card {
                padding: 1rem;
            }
            /* Removed focus-mode-content responsive CSS */
            /* .focus-mode-content {
                padding: 20px;
            } */
        }
    </style>
</head>
<body class="dark">
    <div id="custom-message-box" class="message-box fixed bottom-24 left-1/2 -translate-x-1/2 p-4 rounded-lg shadow-lg text-center opacity-0 invisible transition-all duration-300 z-50 max-w-xs md:max-w-md">
        Message
    </div>

    <!-- Quiz Mode Overlay (Removed)
    <div id="quiz-mode-overlay" class="focus-mode-overlay">
        <div class="focus-mode-content quiz-card glass-effect">
            <button class="close-focus-mode" id="close-quiz-mode-btn">×</button>
            <div class="flex-grow flex flex-col justify-center items-center p-4 w-full">
                <p id="quiz-question" class="quiz-question">What was this note about?</p>
                <p id="quiz-answer" class="quiz-answer hidden"></p>
            </div>
            <div class="quiz-controls">
                <button id="reveal-answer-btn" class="button-primary px-4 py-2 rounded-lg shadow-md">Reveal Answer</button>
                <button id="next-quiz-btn" class="button-primary px-4 py-2 rounded-lg shadow-md">Next Note</button>
            </div>
        </div>
    </div>
    -->

    <div class="max-w-4xl mx-auto p-6 md:p-8 rounded-xl app-container glass-effect">
        <div class="flex justify-between items-center mb-6 header">
            <h1 class="text-3xl font-bold">EveXa Buddy Pad – Smart Notepad</h1>
            <div class="flex space-x-2">
                <button id="show-all-tags-btn" class="p-2 rounded-full icon-button" title="Show All Tags">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 7h.01M7 3h5.99M7 21h5.99M17 7h.01M17 3h5.99M17 21h5.99M12 7h.01M12 3h5.99M12 21h5.99M5 12h.01M3 12h5.99M21 12h.01M15 12h.01M12 17h.01M12 19h.01M12 5h.01M12 7h.01M12 9h.01M12 11h.01M12 13h.01M12 15h.01M12 17h.01M12 19h.01M12 21h.01" />
                    </svg>
                </button>
                <button id="add-content-item-btn" class="p-2 rounded-full icon-button" title="Add New Link/Content">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </button>
                <button id="add-standalone-note-btn" class="p-2 rounded-full icon-button" title="Add Standalone Note">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                    </svg>
                </button>
                <button id="show-insights-btn" class="p-2 rounded-full icon-button" title="Show Insights">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                    </svg>
                </button>
                <button id="show-export-btn" class="p-2 rounded-full icon-button" title="Export Notes">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                </button>
                <button id="theme-toggle" class="p-2 rounded-full icon-button transition duration-300 ease-in-out transform hover:scale-110" title="Toggle Theme">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 3v1m0 16v1m9-9h1M4 12H3m15.325 3.325l-.707.707M6.372 6.372l-.707-.707m12.728 0l-.707.707M6.372 17.628l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                    </svg>
                </button>
            </div>
        </div>

        <div id="all-tags-section" class="mb-6 p-4 rounded-xl card hidden">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">All Tags</h3>
                <button id="back-from-all-tags-btn" class="button-secondary px-4 py-2 rounded-lg shadow-md">Back to Dashboard</button>
            </div>
            <div id="all-tags-container" class="flex flex-wrap">
                </div>
        </div>

        <div id="insights-panel" class="hidden glass-effect">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">Smart Insights</h3>
                <button id="back-from-insights-btn" class="button-secondary px-4 py-2 rounded-lg shadow-md">Back to Dashboard</button>
            </div>
            <p>Total Notes: <span class="insight-value" id="total-notes-count">0</span></p>
            <p>Total Links/Content: <span class="insight-value" id="total-content-items-count">0</span></p>
            <p>Notes untouched for <span class="insight-value" id="untouched-days-threshold">7</span> days: <span class="insight-value" id="untouched-notes-count">0</span></p>
            <p id="streak-counter" class="text-center mt-4"></p>
        </div>

        <div id="export-panel" class="hidden glass-effect">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">Export Notes</h3>
                <button id="back-from-export-btn" class="button-secondary px-4 py-2 rounded-lg shadow-md">Back to Dashboard</button>
            </div>
            <div class="mb-4">
                <label for="export-filter-type" class="block text-sm font-medium mb-2 text-gray-300">Filter by:</label>
                <select id="export-filter-type" class="input-field">
                    <option value="all">All Notes</option>
                    <option value="tag">Specific Tag</option>
                    <option value="contentItem">Specific Link/Content</option>
                    <option value="favorite">Favorites</option>
                    <option value="standalone">Standalone Notes</option>
                    <option value="reviewDate">Notes with Review Date</option>
                </select>
            </div>
            <div id="export-filter-value-container" class="mb-4 hidden">
                <label for="export-filter-value" class="block text-sm font-medium mb-2 text-gray-300">Select Value:</label>
                <select id="export-filter-value" class="input-field">
                    </select>
            </div>
            <div class="flex justify-end space-x-2">
                <button id="export-txt-btn" class="button-primary px-4 py-2 rounded-lg shadow-md">Export as TXT</button>
                <button id="export-json-btn" class="button-primary px-4 py-2 rounded-lg shadow-md">Export as JSON</button>
            </div>
        </div>

        <div id="dashboard-view">
            <h2 class="text-2xl font-semibold mb-4">Your Links & Content</h2>
            <div id="content-items-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <p id="no-content-items-message" class="col-span-full text-center text-gray-400">No links or content saved yet. Add one to get started!</p>
            </div>

            <h2 class="text-2xl font-semibold mt-8 mb-4">Standalone Notes</h2>
            <div id="standalone-notes-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <p id="no-standalone-notes-message" class="col-span-full text-center text-gray-400">No standalone notes yet.</p>
            </div>
        </div>

        <div id="add-content-item-view" class="hidden">
            <div class="p-6 md:p-8 rounded-xl card">
                <h2 class="text-2xl font-semibold mb-4">Add New Link or Content</h2>
                <div class="mb-4">
                    <label for="content-type-select" class="block text-sm font-medium mb-2 text-gray-300">Content Type</label>
                    <select id="content-type-select" class="input-field p-3 rounded-lg w-full">
                        <option value="youtube">YouTube Video</option>
                        <option value="website">Website / Blog / Portfolio</option>
                        <option value="text-only">Note to Self (No Link)</option>
                    </select>
                </div>
                <div class="mb-4" id="content-url-group">
                    <label for="content-url-input" class="block text-sm font-medium mb-2 text-gray-300">URL (optional for "Note to Self")</label>
                    <input type="text" id="content-url-input" placeholder="e.g., https://www.youtube.com/watch?v=dQw4w9WgXcQ or your-website.com" class="input-field p-3 rounded-lg w-full">
                </div>
                <div class="mb-4">
                    <label for="content-title-input" class="block text-sm font-medium mb-2 text-gray-300">Title (e.g., Python Tutorial, My Portfolio)</label>
                    <input type="text" id="content-title-input" placeholder="Enter a descriptive title" class="input-field p-3 rounded-lg w-full">
                </div>
                <div class="flex justify-end space-x-2">
                    <button id="cancel-add-content-item-btn" class="button-secondary px-4 py-2 rounded-lg shadow-md">Cancel</button>
                    <button id="save-content-item-btn" class="button-primary px-4 py-2 rounded-lg shadow-md">Add Content</button>
                </div>
            </div>
        </div>

        <div id="content-item-notes-view" class="hidden">
            <div class="flex items-center mb-4">
                <button id="back-to-dashboard-btn" class="p-2 rounded-full icon-button">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                    </svg>
                </button>
                <h2 id="selected-content-item-title" class="text-2xl font-semibold ml-2 flex-grow break-words-overflow"></h2>
            </div>

            <div id="embedded-viewer-panel" class="w-full bg-black rounded-lg mb-6 overflow-hidden text-gray-200">
                <div class="relative" style="padding-bottom: 56.25%;">
                    <iframe id="content-viewer-iframe" class="absolute top-0 left-0 w-full h-full" src="" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen sandbox="allow-scripts allow-same-origin allow-popups allow-forms allow-autoplay allow-fullscreen allow-accelerometer allow-gyroscope allow-encrypted-media allow-clipboard-write"></iframe>
                </div>
                <div class="p-3 flex justify-center space-x-4 hidden" id="website-controls">
                    <a id="open-in-new-tab-btn" href="#" target="_blank" class="button-primary px-4 py-2 rounded-lg shadow-md">
                        Open in New Tab
                    </a>
                </div>
            </div>

            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">Notes for this Content</h3>
                <button id="add-note-for-content-item-btn-view" class="button-primary px-4 py-2 rounded-lg shadow-md">
                    Add New Note
                </button>
            </div>

            <div id="content-item-notes-list" class="grid grid-cols-1 gap-4">
                <p id="no-content-item-notes-message" class="col-span-full text-center text-gray-400">No notes for this content yet.</p>
            </div>
        </div>

        <div id="add-edit-note-view" class="p-6 md:p-8 rounded-xl card mb-6 hidden">
            <h2 id="note-form-title" class="text-2xl font-semibold mb-4">Add New Note</h2>
            <div class="mb-4">
                <label for="note-content-textarea" class="block text-sm font-medium mb-2 text-gray-300">Note Content</label>
                <textarea id="note-content-textarea" placeholder="Write your note here. Use **bold** or *italic* for emphasis." rows="6" class="input-field p-3 rounded-lg w-full"></textarea>
            </div>

            <div id="content-item-note-fields" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="note-timestamp-input" class="block text-sm font-medium mb-2 text-gray-300">Content Timestamp (MM:SS)</label>
                    <input type="text" id="note-timestamp-input" placeholder="e.g., 01:30" class="input-field p-3 rounded-lg w-full">
                </div>
                <div>
                    <label for="note-start-segment-input" class="block text-sm font-medium mb-2 text-gray-300">Segment Start (MM:SS)</label>
                    <input type="text" id="note-start-segment-input" placeholder="e.g., 00:00" class="input-field p-3 rounded-lg w-full">
                </div>
                <div class="md:col-span-2">
                    <label for="note-end-segment-input" class="block text-sm font-medium mb-2 text-gray-300">Segment End (MM:SS)</label>
                    <input type="text" id="note-end-segment-input" placeholder="e.g., 02:30" class="input-field p-3 rounded-lg w-full">
                </div>
            </div>

            <div class="mb-4">
                <label for="note-intent-input" class="block text-sm font-medium mb-2 text-gray-300">Study Intent (e.g., Exam Prep, Doubt, Long-term)</label>
                <input type="text" id="note-intent-input" placeholder="Why this note matters" class="input-field p-3 rounded-lg w-full">
            </div>

            <div class="mb-4">
                <label for="note-priority-select" class="block text-sm font-medium mb-2 text-gray-300">Priority</label>
                <select id="note-priority-select" class="input-field p-3 rounded-lg w-full">
                    <option value="low">Low</option>
                    <option value="medium">Medium</option>
                    <option value="high">High</option>
                </select>
            </div>

            <div class="mb-4">
                <label for="note-status-select" class="block text-sm font-medium mb-2 text-gray-300">Status</label>
                <select id="note-status-select" class="input-field p-3 rounded-lg w-full">
                    <option value="to-do">To Do</option>
                    <option value="in-progress">In Progress</option>
                    <option value="completed">Completed</option>
                </select>
            </div>

            <div class="mb-4">
                <label for="note-duration-input" class="block text-sm font-medium mb-2 text-gray-300">Estimated Study Time (minutes)</label>
                <input type="number" id="note-duration-input" placeholder="e.g., 20" class="input-field p-3 rounded-lg w-full">
            </div>

            <div class="mb-4">
                <label for="note-review-date-input" class="block text-sm font-medium mb-2 text-gray-300">Schedule Review Date</label>
                <input type="date" id="note-review-date-input" class="input-field p-3 rounded-lg w-full">
            </div>

            <div class="mb-4 tag-suggestions-container">
                <label for="note-tags-input" class="block text-sm font-medium mb-2 text-gray-300">Tags (comma-separated, e.g., Math, Algebra, Lecture)</label>
                <input type="text" id="note-tags-input" placeholder="Add tags for easy filtering" class="input-field p-3 rounded-lg w-full">
                <div id="tag-suggestions" class="tag-suggestions hidden"></div>
            </div>

            <div class="mb-4 flex items-center space-x-4">
                <label class="inline-flex items-center cursor-pointer text-gray-300">
                    <input type="checkbox" id="note-favorite-checkbox" class="form-checkbox h-5 w-5 text-blue-600 rounded">
                    <span class="ml-2">Mark as Favorite</span>
                </label>
                <button class="p-2 rounded-full icon-button opacity-50 cursor-not-allowed" title="Attach Image (Not Implemented)">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                </button>
                <button class="p-2 rounded-full icon-button opacity-50 cursor-not-allowed" title="Record Audio (Not Implemented)">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                    </svg>
                </button>
            </div>

            <div class="flex justify-end space-x-2">
                <button id="cancel-add-edit-note-btn" class="button-secondary px-4 py-2 rounded-lg shadow-md">Cancel</button>
                <button id="save-note-btn" class="button-primary px-4 py-2 rounded-lg shadow-md">Save Note</button>
            </div>
        </div>
    </div>

    <script>
        // --- Global State Variables ---
        let contentItems = []; // Renamed from 'videos'
        let notes = [];
        let currentView = 'dashboard';
        let selectedContentItem = null; // Renamed from 'selectedVideo'
        let editingNote = null;
        let isStandaloneNote = false;
        let filterTag = '';
        let allTags = [];
        let lastNoteCreationDate = localStorage.getItem('lastNoteCreationDate');
        let streakCount = parseInt(localStorage.getItem('streakCount') || '0');
        // Removed quizNotes and currentQuizNoteIndex
        // let quizNotes = [];
        // let currentQuizNoteIndex = 0;

        // --- Constants ---
        const MAX_TITLE_LENGTH = 40; // Max characters before truncation

        // --- DOM Element References ---
        const themeToggle = document.getElementById('theme-toggle');
        const customMessageBox = document.getElementById('custom-message-box');

        const dashboardView = document.getElementById('dashboard-view');
        const contentItemsList = document.getElementById('content-items-list'); // Renamed
        const noContentItemsMessage = document.getElementById('no-content-items-message'); // Renamed
        const standaloneNotesList = document.getElementById('standalone-notes-list');
        const noStandaloneNotesMessage = document.getElementById('no-standalone-notes-message');

        const addContentItemView = document.getElementById('add-content-item-view'); // Renamed
        const contentTypeSelect = document.getElementById('content-type-select'); // New
        const contentUrlGroup = document.getElementById('content-url-group'); // New
        const contentUrlInput = document.getElementById('content-url-input'); // Renamed
        const contentTitleInput = document.getElementById('content-title-input'); // New
        const saveContentItemBtn = document.getElementById('save-content-item-btn'); // Renamed
        const cancelAddContentItemBtn = document.getElementById('cancel-add-content-item-btn'); // Renamed

        const contentItemNotesView = document.getElementById('content-item-notes-view'); // Renamed
        const selectedContentItemTitle = document.getElementById('selected-content-item-title'); // Renamed
        const contentViewerIframe = document.getElementById('content-viewer-iframe'); // Renamed
        // Removed youtubeControls reference
        const websiteControls = document.getElementById('website-controls'); // New
        const openInNewTabBtn = document.getElementById('open-in-new-tab-btn'); // New
        // Removed pauseVideoBtn and resumeVideoBtn references
        const contentItemNotesList = document.getElementById('content-item-notes-list'); // Renamed
        const noContentItemNotesMessage = document.getElementById('no-content-item-notes-message'); // Renamed
        const addNoteForContentItemBtnDashboard = document.getElementById('add-note-for-content-item-btn'); // Renamed from addNoteForContentItemBtn
        const addNoteForContentItemBtnView = document.getElementById('add-note-for-content-item-btn-view'); // New ID for button on content notes view
        const backToDashboardBtn = document.getElementById('back-to-dashboard-btn');

        // Note: addEditNoteView is now a sibling of contentItemNotesView in HTML
        const addEditNoteView = document.getElementById('add-edit-note-view');
        const noteFormTitle = document.getElementById('note-form-title');
        const noteContentTextarea = document.getElementById('note-content-textarea');
        const noteTimestampInput = document.getElementById('note-timestamp-input');
        const noteStartSegmentInput = document.getElementById('note-start-segment-input');
        const noteEndSegmentInput = document.getElementById('note-end-segment-input');
        const noteIntentInput = document.getElementById('note-intent-input');
        const notePrioritySelect = document.getElementById('note-priority-select'); // New
        const noteStatusSelect = document.getElementById('note-status-select');     // New
        const noteDurationInput = document.getElementById('note-duration-input');
        const noteReviewDateInput = document.getElementById('note-review-date-input');
        const noteTagsInput = document.getElementById('note-tags-input');
        const noteFavoriteCheckbox = document.getElementById('note-favorite-checkbox');
        const contentItemNoteFields = document.getElementById('content-item-note-fields'); // Renamed from videoNoteFields
        const saveNoteBtn = document.getElementById('save-note-btn');
        const cancelAddEditNoteBtn = document.getElementById('cancel-add-edit-note-btn');
        const tagSuggestionsContainer = document.getElementById('tag-suggestions');

        const showAllTagsBtn = document.getElementById('show-all-tags-btn');
        const addContentItemBtn = document.getElementById('add-content-item-btn'); // Renamed
        const addStandaloneNoteBtn = document.getElementById('add-standalone-note-btn');
        const allTagsSection = document.getElementById('all-tags-section');
        const allTagsContainer = document.getElementById('all-tags-container');
        const backFromAllTagsBtn = document.getElementById('back-from-all-tags-btn'); // New

        const showInsightsBtn = document.getElementById('show-insights-btn');
        const insightsPanel = document.getElementById('insights-panel');
        const totalNotesCount = document.getElementById('total-notes-count');
        const totalContentItemsCount = document.getElementById('total-content-items-count'); // Renamed
        const untouchedNotesCount = document.getElementById('untouched-notes-count');
        const untouchedDaysThreshold = document.getElementById('untouched-days-threshold');
        const streakCounterDisplay = document.getElementById('streak-counter');
        const backFromInsightsBtn = document.getElementById('back-from-insights-btn'); // New

        const showExportBtn = document.getElementById('show-export-btn');
        const exportPanel = document.getElementById('export-panel');
        const exportFilterType = document.getElementById('export-filter-type');
        const exportFilterValueContainer = document.getElementById('export-filter-value-container');
        const exportFilterValue = document.getElementById('export-filter-value');
        const exportTxtBtn = document.getElementById('export-txt-btn');
        const exportJsonBtn = document.getElementById('export-json-btn');
        const backFromExportBtn = document.getElementById('back-from-export-btn'); // New

        // Removed focus mode DOM element references
        // const focusModeOverlay = document.getElementById('focus-mode-overlay');
        // const closeFocusModeBtn = document.getElementById('close-focus-mode-btn');
        // const focusNoteTitle = document.getElementById('focus-note-title');
        // const focusNoteContent = document.getElementById('focus-note-content');
        // const focusNoteDetails = document.getElementById('focus-note-details');

        // Removed quiz mode DOM element references
        // const quizModeOverlay = document.getElementById('quiz-mode-overlay');
        // const closeQuizModeBtn = document.getElementById('close-quiz-mode-btn');
        // const quizQuestion = document.getElementById('quiz-question');
        // const quizAnswer = document.getElementById('quiz-answer');
        // const revealAnswerBtn = document.getElementById('reveal-answer-btn');
        // const nextQuizBtn = document.getElementById('next-quiz-btn');

        // --- Utility Functions ---

        /**
         * Shows a custom message box.
         * @param {string} message - The message to display.
         * @param {string} type - 'info', 'success', or 'error'.
         * @param {number} duration - How long the message should be visible in ms.
         */
        function showMessageBox(message, type = 'info', duration = 3000) {
            customMessageBox.textContent = message;
            customMessageBox.className = `message-box fixed bottom-24 left-1/2 -translate-x-1/2 p-4 rounded-lg shadow-lg text-center opacity-0 invisible transition-all duration-300 z-50 max-w-xs md:max-w-md`; // Reset classes
            
            if (type === 'error') {
                customMessageBox.classList.add('error');
            } else if (type === 'success') {
                customMessageBox.classList.add('success');
            } else {
                customMessageBox.classList.add('info');
            }

            // Show the message
            customMessageBox.classList.remove('opacity-0', 'invisible');
            customMessageBox.classList.add('opacity-100', 'visible');

            // Hide after duration
            setTimeout(() => {
                customMessageBox.classList.remove('opacity-100', 'visible');
                customMessageBox.classList.add('opacity-0', 'invisible');
            }, duration);
        }

        /**
         * Extracts YouTube video ID from a given URL.
         * @param {string} url - The YouTube video URL.
         * @returns {string|null} The video ID or null if not found.
         */
        function extractYouTubeVideoId(url) {
            const regex = /(?:https?:\/\/)?(?:www\.)?(?:m\.)?(?:youtube\.com|youtu\.be)\/(?:watch\?v=|embed\/|v\/|)([\w-]{11})(?:\S+)?/;
            const match = url.match(regex);
            return match ? match[1] : null;
        }

        /**
         * Formats seconds into MM:SS string.
         * @param {number} seconds - Total seconds.
         * @returns {string} Formatted time string.
         */
        function formatTimestamp(seconds) {
            if (isNaN(seconds) || seconds < 0) return '00:00';
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = Math.floor(seconds % 60);
            return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
        }

        /**
         * Parses MM:SS string into total seconds.
         * @param {string} timestampString - Time string in MM:SS format.
         * @returns {number|null} Total seconds or null if invalid.
         */
        function parseTimestamp(timestampString) {
            if (!timestampString) return null;
            const parts = timestampString.split(':');
            if (parts.length === 2) {
                const minutes = parseInt(parts[0], 10);
                const seconds = parseInt(parts[1], 10);
                if (!isNaN(minutes) && !isNaN(seconds)) {
                    return minutes * 60 + seconds;
                }
            }
            return null;
        }

        /**
         * Generates a consistent hash-based color for a string (e.g., tag).
         * @param {string} str - The string to hash.
         * @returns {string} A hex color string.
         */
        function stringToHslColor(str, s, l) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                hash = str.charCodeAt(i) + ((hash << 5) - hash);
            }
            let h = hash % 360;
            return `hsl(${h}, ${s}%, ${l}%)`;
        }

        /**
         * Applies the current theme to the body.
         */
        function applyTheme() {
            document.body.className = localStorage.getItem('theme') || 'dark';
            // Update theme toggle icon
            const isDark = document.body.classList.contains('dark');
            themeToggle.innerHTML = isDark
                ? `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 3v1m0 16v1m9-9h1M4 12H3m15.325 3.325l-.707.707M6.372 6.372l-.707-.707m12.728 0l-.707.707M6.372 17.628l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                </svg>`
                : `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9 9 0 008.354-5.646z" />
                </svg>`;

            // Re-render dashboard to apply new theme colors to dynamically generated elements
            if (currentView === 'dashboard') {
                renderDashboard();
            } else if (currentView === 'contentItemNotes' && selectedContentItem) {
                renderContentItemNotes();
            } else if (currentView === 'allTags') {
                renderAllTags();
            }
        }

        // --- Data Management (localStorage) ---

        /**
         * Loads contentItems and notes from localStorage.
         */
        function loadData() {
            contentItems = JSON.parse(localStorage.getItem('smartNotepadContentItems')) || [];
            notes = JSON.parse(localStorage.getItem('smartNotepadNotes')) || [];
            lastNoteCreationDate = localStorage.getItem('lastNoteCreationDate');
            streakCount = parseInt(localStorage.getItem('streakCount') || '0');
            updateAllTags();
            applyTheme(); // Load theme preference
        }

        /**
         * Saves contentItems and notes to localStorage.
         */
        function saveData() {
            localStorage.setItem('smartNotepadContentItems', JSON.stringify(contentItems));
            localStorage.setItem('smartNotepadNotes', JSON.stringify(notes));
            localStorage.setItem('lastNoteCreationDate', lastNoteCreationDate);
            localStorage.setItem('streakCount', streakCount.toString());
            updateAllTags();
        }

        /**
         * Updates the global allTags array from current notes.
         */
        function updateAllTags() {
            const tagsSet = new Set();
            notes.forEach(note => {
                if (note.tags && Array.isArray(note.tags)) {
                    note.tags.forEach(tag => tagsSet.add(tag));
                }
            });
            allTags = Array.from(tagsSet).sort();
        }

        // --- View Management ---

        /**
         * Switches the active view.
         * @param {string} viewName - The ID of the view to show ('dashboard', 'addContentItem', etc.).
         */
        function showView(viewName) {
            // Hide all main views first
            dashboardView.classList.add('hidden');
            addContentItemView.classList.add('hidden');
            contentItemNotesView.classList.add('hidden');
            allTagsSection.classList.add('hidden');
            insightsPanel.classList.add('hidden');
            exportPanel.classList.add('hidden');

            // Always hide the note form when switching main views, unless it's specifically for adding/editing a note
            // This is important because the note form can be shown in two contexts (standalone or linked)
            addEditNoteView.classList.add('hidden');

            currentView = viewName;

            switch (viewName) {
                case 'dashboard':
                    dashboardView.classList.remove('hidden');
                    renderDashboard();
                    break;
                case 'addContentItem':
                    addContentItemView.classList.remove('hidden');
                    contentUrlInput.value = '';
                    contentTitleInput.value = '';
                    contentTypeSelect.value = 'youtube';
                    contentUrlGroup.classList.remove('hidden');
                    break;
                case 'contentItemNotes':
                    contentItemNotesView.classList.remove('hidden');
                    renderContentItemNotes();
                    break;
                case 'addNote': // This is the key change
                    // If it's a standalone note, show it as a primary view
                    if (isStandaloneNote) {
                        dashboardView.classList.add('hidden'); // Ensure dashboard is hidden
                        addEditNoteView.classList.remove('hidden');
                    } else {
                        // If it's a linked note, keep contentItemNotesView visible and show the form within it
                        contentItemNotesView.classList.remove('hidden');
                        addEditNoteView.classList.remove('hidden'); // This is the crucial part
                    }
                    renderAddEditNoteForm();
                    break;
                case 'allTags':
                    allTagsSection.classList.remove('hidden');
                    renderAllTags();
                    break;
                case 'insights':
                    insightsPanel.classList.remove('hidden');
                    renderInsights();
                    break;
                case 'export':
                    exportPanel.classList.remove('hidden');
                    renderExportPanel();
                    break;
            }
        }

        // --- Render Functions ---

        /**
         * Renders the main dashboard with content items and standalone notes.
         */
        function renderDashboard() {
            const isDark = document.body.classList.contains('dark');

            // Render Content Items
            contentItemsList.innerHTML = '';
            const linkedContentItems = contentItems.filter(item => item.type !== 'text-only'); // Don't show notes-to-self here
            if (linkedContentItems.length === 0) {
                noContentItemsMessage.classList.remove('hidden');
            } else {
                noContentItemsMessage.classList.add('hidden');
                linkedContentItems.forEach(item => {
                    const itemCard = document.createElement('div');
                    // Added text-center and break-words to the card for general alignment and wrapping
                    itemCard.className = `relative p-4 mb-4 rounded-xl card glass-effect text-center break-words ${isDark ? 'text-white' : 'text-gray-800'}`;
                    
                    let thumbnailHtml = '';
                    if (item.type === 'youtube' && item.thumbnail) {
                        thumbnailHtml = `<img src="${item.thumbnail}" alt="${item.title}" class="w-full h-32 object-cover rounded-lg mb-3" onerror="this.onerror=null;this.src='https://placehold.co/320x180/333333/FFFFFF?text=Video';">`;
                    } else if (item.type === 'website') {
                        thumbnailHtml = `<div class="w-full h-32 flex items-center justify-center bg-gray-700 rounded-lg mb-3">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                                            </svg>
                                        </div>`;
                    } else { // Generic fallback
                        thumbnailHtml = `<div class="w-full h-32 flex items-center justify-center bg-gray-700 rounded-lg mb-3">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                            </svg>
                                        </div>`;
                    }

                    // Title handling with "See more"
                    let titleHtml = `<h3 class="text-lg font-semibold mb-2 ${isDark ? 'text-white' : 'text-gray-800'}">`;
                    if (item.title.length > MAX_TITLE_LENGTH) {
                        const truncatedTitle = item.title.substring(0, MAX_TITLE_LENGTH) + '...';
                        titleHtml += `
                            <span class="truncated-title-container">
                                <span class="title-text-truncated">${truncatedTitle}</span>
                                <span class="title-text-full hidden">${item.title}</span>
                                <span class="toggle-title-btn" data-full-title="${item.title}">See more</span>
                            </span>
                        `;
                    } else {
                        titleHtml += `${item.title}`;
                    }
                    titleHtml += `</h3>`;


                    itemCard.innerHTML = `
                        ${thumbnailHtml}
                        ${titleHtml}
                        <p class="${isDark ? 'text-gray-400' : 'text-gray-600'}"><span class="font-medium">Notes:</span> ${notes.filter(n => n.contentItemId === item.id).length}</p>
                        <div class="flex flex-wrap mt-2 justify-center">
                            ${notes.filter(n => n.contentItemId === item.id).flatMap(n => n.tags || []).filter((value, index, self) => self.indexOf(value) === index).map(tag => `<span class="inline-block px-3 py-1 text-sm rounded-full mr-2 mb-2 tag-pill cursor-pointer" style="background-color: ${stringToHslColor(tag, 50, isDark ? 30 : 80)}; color: ${isDark ? 'var(--text-light)' : 'var(--text-dark)'};" data-tag="${tag}">#${tag}</span>`).join('')}
                        </div>
                        <div class="flex justify-between mt-4">
                            <button class="button-primary px-4 py-2 rounded-lg shadow-md view-notes-btn" data-content-item-id="${item.id}">
                                View Notes
                            </button>
                            <div class="flex space-x-2">
                                <button class="p-2 rounded-full icon-button add-note-for-content-item-btn" data-content-item-id="${item.id}" title="Add Note">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                </button>
                                <button class="p-2 rounded-full icon-button delete-content-item-btn" data-content-item-id="${item.id}" title="Delete Link">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                    `;
                    contentItemsList.appendChild(itemCard);
                });
            }

            // Render Standalone Notes
            standaloneNotesList.innerHTML = '';
            const standaloneNotes = notes.filter(n => n.isStandalone && (!filterTag || (n.tags && n.tags.includes(filterTag))))
                                        .sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0)); // Sort by creation date descending
            if (standaloneNotes.length === 0) {
                noStandaloneNotesMessage.classList.remove('hidden');
            } else {
                noStandaloneNotesMessage.classList.add('hidden');
                standaloneNotes.forEach(note => {
                    const noteCard = document.createElement('div');
                    // Added text-center and break-words to the card for general alignment and wrapping
                    noteCard.className = `relative p-4 mb-4 rounded-xl card glass-effect text-center break-words ${isDark ? 'text-white' : 'text-gray-800'}`;
                    noteCard.innerHTML = `
                        <h3 class="text-lg font-semibold mb-2 flex items-center justify-center">
                            ${note.isFavorite ? `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 favorite-icon mr-2" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.538 1.118l-2.8-2.034a1 1 0 00-1.176 0l-2.8 2.034c-.783.57-1.838-.197-1.538-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.462a1 1 0 00.95-.69l1.07-3.292z" /></svg>` : ''}
                            Standalone Note
                        </h3>
                        <p class="text-sm ${isDark ? 'text-gray-300' : 'text-gray-700'} mb-2">${note.content.substring(0, 100)}...</p>
                        ${note.intent ? `<p class="text-xs ${isDark ? 'text-gray-500' : 'text-gray-500'}">Intent: ${note.intent}</p>` : ''}
                        ${note.priority ? `<p class="text-xs ${isDark ? 'text-gray-500' : 'text-gray-500'}">Priority: <span class="priority-${note.priority}">${note.priority.charAt(0).toUpperCase() + note.priority.slice(1)}</span></p>` : ''}
                        ${note.status ? `<p class="text-xs ${isDark ? 'text-gray-500' : 'text-gray-500'}">Status: <span class="status-${note.status}">${note.status.split('-').map(s => s.charAt(0).toUpperCase() + s.slice(1)).join(' ')}</span></p>` : ''}
                        ${note.estimatedDuration ? `<p class="text-xs ${isDark ? 'text-gray-500' : 'text-gray-500'}">Est. Time: ${note.estimatedDuration} mins</p>` : ''}
                        ${note.reviewDate ? `<p class="text-xs ${isDark ? 'text-gray-500' : 'text-gray-500'}">Review: ${new Date(note.reviewDate).toLocaleDateString()}</p>` : ''}
                        <div class="flex flex-wrap mt-2 justify-center">
                            ${(note.tags || []).map(tag => `<span class="inline-block px-3 py-1 text-sm rounded-full mr-2 mb-2 tag-pill cursor-pointer" style="background-color: ${stringToHslColor(tag, 50, isDark ? 30 : 80)}; color: ${isDark ? 'var(--text-light)' : 'var(--text-dark)'};" data-tag="${tag}">#${tag}</span>`).join('')}
                        </div>
                        <div class="flex justify-end mt-4 space-x-2">
                            <!--
                            <button class="p-2 rounded-full icon-button focus-note-btn" data-note-id="${note.id}" title="Focus Mode">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z" />
                                </svg>
                            </button>
                            -->
                            <!--
                            <button class="p-2 rounded-full icon-button quiz-note-btn" data-note-id="${note.id}" title="Quiz Me">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8.228 9.247a1 1 0 01.791-.595 1 1 0 01.903.868l1.498 4.993 2.502-2.502a1 1 0 01.83-.293 1 1 0 01.791.595l1.498 4.993a1 1 0 01-.791 1.352 1 1 0 01-.903-.868l-1.498-4.993L13.5 11.5l-2.502 2.502a1 1 0 01-.83.293 1 1 0 01-.791-.595l-1.498-4.993a1 1 0 01.791-1.352z" />
                                </svg>
                            </button>
                            -->
                            <button class="p-2 rounded-full icon-button edit-note-btn" data-note-id="${note.id}" title="Edit">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                </svg>
                            </button>
                            <button class="p-2 rounded-full icon-button delete-note-btn" data-note-id="${note.id}" title="Delete">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </div>
                    `;
                    standaloneNotesList.appendChild(noteCard);
                });
            }
        }

        /**
         * Renders notes for the currently selected content item.
         */
        function renderContentItemNotes() {
            if (!selectedContentItem) {
                showView('dashboard'); // Go back if no content item selected
                return;
            }
            const isDark = document.body.classList.contains('dark');

            selectedContentItemTitle.textContent = selectedContentItem.title;

            // Set iframe src based on content type
            if (selectedContentItem.type === 'youtube') {
                // Corrected YouTube embed URL
                contentViewerIframe.src = `https://www.youtube.com/embed/${extractYouTubeVideoId(selectedContentItem.url)}`;
                websiteControls.classList.add('hidden');
                contentItemNoteFields.classList.remove('hidden'); // Show timestamp fields for YouTube
            } else if (selectedContentItem.type === 'website') {
                contentViewerIframe.src = selectedContentItem.url;
                websiteControls.classList.add('hidden');
                openInNewTabBtn.href = selectedContentItem.url;
                contentItemNoteFields.classList.add('hidden'); // Hide timestamp fields for websites
            } else { // text-only or other types without a direct embed
                contentViewerIframe.src = 'about:blank'; // Clear iframe content
                websiteControls.classList.add('hidden');
                contentItemNoteFields.classList.add('hidden'); // Hide timestamp fields
            }

            // Ensure the note form is hidden when rendering notes initially
            addEditNoteView.classList.add('hidden');

            contentItemNotesList.innerHTML = '';
            const contentItemSpecificNotes = notes.filter(n => n.contentItemId === selectedContentItem.id && (!filterTag || (n.tags && n.tags.includes(filterTag))))
                                            .sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0)); // Sort by creation date descending

            if (contentItemSpecificNotes.length === 0) {
                noContentItemNotesMessage.classList.remove('hidden');
            } else {
                noContentItemNotesMessage.classList.add('hidden');
                contentItemSpecificNotes.forEach(note => {
                    const noteCard = document.createElement('div');
                    // Added text-center and break-words to the note card for general alignment and wrapping
                    noteCard.className = `relative p-4 mb-4 rounded-xl card glass-effect text-center break-words ${isDark ? 'text-white' : 'text-gray-800'}`;
                    noteCard.innerHTML = `
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex items-center">
                                ${note.timestamp ? `<span class="text-lg font-bold mr-3 ${isDark ? 'text-blue-300' : 'text-blue-600'}">${formatTimestamp(note.timestamp)}</span>` : ''}
                                ${note.startSegment && note.endSegment ? `<span class="text-sm ${isDark ? 'text-gray-400' : 'text-gray-600'}">(${formatTimestamp(note.startSegment)} - ${formatTimestamp(note.endSegment)})</span>` : ''}
                            </div>
                            ${note.isFavorite ? `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 favorite-icon" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.538 1.118l-2.8-2.034a1 1 0 00-1.176 0l-2.8 2.034c-.783.57-1.838-.197-1.538-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.462a1 1 0 00.95-.69l1.07-3.292z" /></svg>` : ''}
                        </div>
                        <p class="mb-3 ${isDark ? 'text-gray-200' : 'text-gray-800'}">${note.content}</p>
                        ${note.intent ? `<p class="text-xs ${isDark ? 'text-gray-500' : 'text-gray-500'}">Intent: ${note.intent}</p>` : ''}
                        ${note.priority ? `<p class="text-xs ${isDark ? 'text-gray-500' : 'text-gray-500'}">Priority: <span class="priority-${note.priority}">${note.priority.charAt(0).toUpperCase() + note.priority.slice(1)}</span></p>` : ''}
                        ${note.status ? `<p class="text-xs ${isDark ? 'text-gray-500' : 'text-gray-500'}">Status: <span class="status-${note.status}">${note.status.split('-').map(s => s.charAt(0).toUpperCase() + s.slice(1)).join(' ')}</span></p>` : ''}
                        ${note.estimatedDuration ? `<p class="text-xs ${isDark ? 'text-gray-500' : 'text-gray-500'}">Est. Time: ${note.estimatedDuration} mins</p>` : ''}
                        ${note.reviewDate ? `<p class="text-xs ${isDark ? 'text-gray-500' : 'text-gray-500'}">Review: ${new Date(note.reviewDate).toLocaleDateString()}</p>` : ''}
                        <div class="flex flex-wrap justify-center">
                            ${(note.tags || []).map(tag => `<span class="inline-block px-3 py-1 text-sm rounded-full mr-2 mb-2 tag-pill cursor-pointer" style="background-color: ${stringToHslColor(tag, 50, isDark ? 30 : 80)}; color: ${isDark ? 'var(--text-light)' : 'var(--text-dark)'};" data-tag="${tag}">#${tag}</span>`).join('')}
                        </div>
                        <div class="flex justify-end mt-4 space-x-2">
                            <!--
                            <button class="p-2 rounded-full icon-button focus-note-btn" data-note-id="${note.id}" title="Focus Mode">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z" />
                                </svg>
                            </button>
                            -->
                            <!--
                            <button class="p-2 rounded-full icon-button quiz-note-btn" data-note-id="${note.id}" title="Quiz Me">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8.228 9.247a1 1 0 01.791-.595 1 1 0 01.903.868l1.498 4.993 2.502-2.502a1 1 0 01.83-.293 1 1 0 01.791.595l1.498 4.993a1 1 0 01-.791 1.352 1 1 0 01-.903-.868l-1.498-4.993L13.5 11.5l-2.502 2.502a1 1 0 01-.83.293 1 1 0 01-.791-.595l-1.498-4.993a1 1 0 01.791-1.352z" />
                                </svg>
                            </button>
                            -->
                            <button class="p-2 rounded-full icon-button edit-note-btn" data-note-id="${note.id}" title="Edit">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                </svg>
                            </button>
                            <button class="p-2 rounded-full icon-button delete-note-btn" data-note-id="${note.id}" title="Delete">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </div>
                    `;
                    contentItemNotesList.appendChild(noteCard);
                });
            }
        }

        /**
         * Renders the add/edit note form.
         */
        function renderAddEditNoteForm() {
            const isDark = document.body.classList.contains('dark');
            noteContentTextarea.className = `input-field p-3 rounded-lg w-full ${isDark ? 'text-white' : 'text-gray-800'}`;
            noteTimestampInput.className = `input-field p-3 rounded-lg w-full ${isDark ? 'text-white' : 'text-gray-800'}`;
            noteStartSegmentInput.className = `input-field p-3 rounded-lg w-full ${isDark ? 'text-white' : 'text-gray-800'}`;
            noteEndSegmentInput.className = `input-field p-3 rounded-lg w-full ${isDark ? 'text-white' : 'text-gray-800'}`;
            noteIntentInput.className = `input-field p-3 rounded-lg w-full ${isDark ? 'text-white' : 'text-gray-800'}`;
            notePrioritySelect.className = `input-field p-3 rounded-lg w-full ${isDark ? 'text-white' : 'text-gray-800'}`;
            noteStatusSelect.className = `input-field p-3 rounded-lg w-full ${isDark ? 'text-white' : 'text-gray-800'}`;
            noteDurationInput.className = `input-field p-3 rounded-lg w-full ${isDark ? 'text-white' : 'text-gray-800'}`;
            noteReviewDateInput.className = `input-field p-3 rounded-lg w-full ${isDark ? 'text-white' : 'text-gray-800'}`;
            noteTagsInput.className = `input-field p-3 rounded-lg w-full ${isDark ? 'text-white' : 'text-gray-800'}`;

            if (editingNote) {
                noteFormTitle.textContent = 'Edit Note';
                noteContentTextarea.value = editingNote.content;
                noteTagsInput.value = (editingNote.tags || []).join(', ');
                noteFavoriteCheckbox.checked = editingNote.isFavorite || false;
                noteTimestampInput.value = editingNote.timestamp ? formatTimestamp(editingNote.timestamp) : '';
                noteStartSegmentInput.value = editingNote.startSegment ? formatTimestamp(editingNote.startSegment) : '';
                noteEndSegmentInput.value = editingNote.endSegment ? formatTimestamp(editingNote.endSegment) : '';
                noteIntentInput.value = editingNote.intent || '';
                notePrioritySelect.value = editingNote.priority || 'medium'; // Default to medium
                noteStatusSelect.value = editingNote.status || 'to-do';     // Default to to-do
                noteDurationInput.value = editingNote.estimatedDuration || '';
                noteReviewDateInput.value = editingNote.reviewDate || ''; //ISO-MM-DD format
                // Hide timestamp/segment fields if it's a standalone note or non-YouTube content
                const hideTimestampFields = editingNote.isStandalone || (selectedContentItem && selectedContentItem.type !== 'youtube');
                contentItemNoteFields.classList.toggle('hidden', hideTimestampFields);
            } else {
                // If adding a new note, clear previous values
                noteFormTitle.textContent = isStandaloneNote ? 'Add Standalone Note' : `Add New Note`;
                noteContentTextarea.value = '';
                noteTagsInput.value = '';
                noteFavoriteCheckbox.checked = false;
                noteTimestampInput.value = '';
                noteStartSegmentInput.value = '';
                noteEndSegmentInput.value = '';
                noteIntentInput.value = '';
                notePrioritySelect.value = 'medium'; // Default for new notes
                noteStatusSelect.value = 'to-do';     // Default for new notes
                noteDurationInput.value = '';
                noteReviewDateInput.value = '';
                // Show/hide timestamp/segment fields based on whether it's a standalone note or non-YouTube content
                const hideTimestampFields = isStandaloneNote || (selectedContentItem && selectedContentItem.type !== 'youtube');
                contentItemNoteFields.classList.toggle('hidden', hideTimestampFields);
            }
            tagSuggestionsContainer.classList.add('hidden'); // Hide suggestions when form opens
            addEditNoteView.classList.remove('hidden'); // Show the form
        }

        /**
         * Renders all unique tags for filtering.
         */
        function renderAllTags() {
            allTagsContainer.innerHTML = '';
            if (allTags.length === 0) {
                allTagsContainer.innerHTML = '<p class="text-gray-400">No tags created yet.</p>';
                return;
            }
            const isDark = document.body.classList.contains('dark');

            allTags.forEach(tag => {
                const tagSpan = document.createElement('span');
                tagSpan.className = `inline-block px-3 py-1 text-sm rounded-full mr-2 mb-2 tag-pill cursor-pointer ${filterTag === tag ? 'active-filter' : ''}`;
                tagSpan.textContent = `#${tag}`;
                tagSpan.style.backgroundColor = stringToHslColor(tag, 50, isDark ? 30 : 80);
                tagSpan.style.color = isDark ? 'var(--text-light)' : 'var(--text-dark)';
                tagSpan.dataset.tag = tag;
                allTagsContainer.appendChild(tagSpan);
            });

            if (filterTag) {
                const clearFilterBtn = document.createElement('button');
                clearFilterBtn.className = `px-3 py-1 text-sm rounded-full bg-red-500 text-white mr-2 mb-2 tag-pill cursor-pointer`;
                clearFilterBtn.textContent = `Clear Filter (${filterTag})`;
                clearFilterBtn.onclick = () => {
                    filterTag = '';
                    showView('dashboard'); // Re-render dashboard without filter
                };
                allTagsContainer.appendChild(clearFilterBtn);
            }
        }

        /**
         * Renders the insights panel.
         */
        function renderInsights() {
            totalNotesCount.textContent = notes.length;
            totalContentItemsCount.textContent = contentItems.length;

            const today = new Date();
            today.setHours(0, 0, 0, 0); // Normalize to start of day

            const sevenDaysAgo = new Date(today);
            sevenDaysAgo.setDate(today.getDate() - 7);

            const untouchedNotes = notes.filter(note => {
                const lastModified = note.lastModifiedAt ? new Date(note.lastModifiedAt) : new Date(note.createdAt);
                return lastModified < sevenDaysAgo.getTime();
            });
            untouchedNotesCount.textContent = untouchedNotes.length;

            // Render Streak Counter
            updateStreakCounter();
        }

        /**
         * Renders the export panel and populates options.
         */
        function renderExportPanel() {
            populateExportFilterValues();
            exportFilterType.value = 'all'; // Reset filter type
            exportFilterValueContainer.classList.add('hidden'); // Hide value selector initially
        }

        /**
         * Populates the export filter value dropdown based on filter type.
         */
        function populateExportFilterValues() {
            exportFilterValue.innerHTML = '';
            const filterType = exportFilterType.value;
            let options = [];

            if (filterType === 'tag') {
                options = allTags.map(tag => ({ value: tag, text: tag }));
            } else if (filterType === 'contentItem') { // Changed from 'video'
                options = contentItems.map(item => ({ value: item.id, text: item.title }));
            } else if (filterType === 'reviewDate') {
                // For reviewDate, we might just show a message or a list of notes with review dates
                // For simplicity, we'll just show the filter type and let the export function handle the logic.
                // No specific options for this dropdown in this simple implementation.
            }

            if (options.length > 0) {
                options.forEach(optionData => {
                    const option = document.createElement('option');
                    option.value = optionData.value;
                    option.textContent = optionData.text;
                    exportFilterValue.appendChild(option);
                });
                exportFilterValueContainer.classList.remove('hidden');
            } else {
                exportFilterValueContainer.classList.add('hidden');
            }
        }

        // --- Feature Specific Functions ---

        // Removed enterFocusMode function
        /*
        function enterFocusMode(noteId) {
            const note = notes.find(n => n.id === noteId);
            if (!note) {
                showMessageBox('Note not found for focus mode.', 'error');
                return;
            }

            focusNoteTitle.textContent = note.isStandalone ? 'Standalone Note' : (contentItems.find(item => item.id === note.contentItemId)?.title || 'Linked Note');
            focusNoteContent.textContent = note.content;

            let details = [];
            if (note.timestamp) details.push(`Timestamp: ${formatTimestamp(note.timestamp)}`);
            if (note.startSegment && note.endSegment) details.push(`Segment: ${formatTimestamp(note.startSegment)} - ${formatTimestamp(note.endSegment)}`);
            if (note.intent) details.push(`Intent: ${note.intent}`);
            if (note.priority) details.push(`Priority: ${note.priority.charAt(0).toUpperCase() + note.priority.slice(1)}`);
            if (note.status) details.push(`Status: ${note.status.split('-').map(s => s.charAt(0).toUpperCase() + s.slice(1)).join(' ')}`);
            if (note.estimatedDuration) details.push(`Est. Time: ${note.estimatedDuration} mins`);
            if (note.reviewDate) details.push(`Review: ${new Date(note.reviewDate).toLocaleDateString()}`);
            if (note.tags && note.tags.length > 0) details.push(`Tags: ${note.tags.map(t => `#${t}`).join(', ')}`);
            if (note.isFavorite) details.push(`Favorite: Yes`);

            focusNoteDetails.innerHTML = details.join(' | ');

            focusModeOverlay.classList.add('active');
        }
        */

        // Removed exitFocusMode function
        /*
        function exitFocusMode() {
            focusModeOverlay.classList.remove('active');
        }
        */

        /**
         * Updates the streak counter.
         */
        function updateStreakCounter() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            if (lastNoteCreationDate) {
                const lastDate = new Date(parseInt(lastNoteCreationDate));
                lastDate.setHours(0, 0, 0, 0);

                const diffTime = Math.abs(today.getTime() - lastDate.getTime());
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                if (diffDays === 1) { // Created note yesterday
                    // Streak continues, no change to streakCount until a new note is added today
                } else if (diffDays > 1) { // Gap in streak
                    streakCount = 0;
                }
            } else { // First note ever
                streakCount = 0; // Will be incremented when a note is saved
            }

            if (streakCount > 0) {
                streakCounterDisplay.textContent = `🔥 ${streakCount}-day streak!`;
            } else {
                streakCounterDisplay.textContent = `Start a streak by adding a note today!`;
            }
        }

        // Removed quiz mode functions
        /*
        function startQuizMode(notesToQuiz) {
            if (notesToQuiz.length === 0) {
                showMessageBox('No notes available for quizzing.', 'info');
                return;
            }
            quizNotes = notesToQuiz;
            currentQuizNoteIndex = 0;
            quizModeOverlay.classList.add('active');
            displayQuizNote();
        }

        function displayQuizNote() {
            if (quizNotes.length === 0) {
                showMessageBox('No more notes in this quiz session.', 'info');
                exitQuizMode();
                return;
            }
            const note = quizNotes[currentQuizNoteIndex];
            quizQuestion.textContent = "What was this note about?"; // Generic question
            quizAnswer.textContent = note.content; // The actual note content is the answer
            quizAnswer.classList.add('hidden'); // Hide answer initially
            revealAnswerBtn.textContent = 'Reveal Answer';
        }

        function exitQuizMode() {
            quizModeOverlay.classList.remove('active');
            quizNotes = [];
            currentQuizNoteIndex = 0;
        }
        */

        /**
         * Handles tag input for suggestions.
         */
        function handleTagInput() {
            const inputValue = noteTagsInput.value.toLowerCase().trim();
            const currentTags = inputValue.split(',').map(tag => tag.trim()).filter(tag => tag !== '');
            const lastTagPart = currentTags.length > 0 ? currentTags[currentTags.length - 1] : '';

            tagSuggestionsContainer.innerHTML = '';
            if (lastTagPart.length > 0) {
                const matchingTags = allTags.filter(tag => tag.toLowerCase().startsWith(lastTagPart) && !currentTags.includes(tag));
                if (matchingTags.length > 0) {
                    matchingTags.forEach(tag => {
                        const suggestionItem = document.createElement('div');
                        suggestionItem.classList.add('tag-suggestion-item');
                        suggestionItem.textContent = tag;
                        suggestionItem.addEventListener('click', () => {
                            const newTags = currentTags.slice(0, -1); // Remove incomplete last tag
                            newTags.push(tag); // Add selected tag
                            noteTagsInput.value = newTags.join(', ') + ', '; // Add comma for next tag
                            tagSuggestionsContainer.classList.add('hidden');
                            noteTagsInput.focus();
                        });
                        tagSuggestionsContainer.appendChild(suggestionItem);
                    });
                    tagSuggestionsContainer.classList.remove('hidden');
                } else {
                    tagSuggestionsContainer.classList.add('hidden');
                }
            } else {
                tagSuggestionsContainer.classList.add('hidden');
            }
        }

        /**
         * Handles export functionality.
         * @param {string} format - 'txt' or 'json'.
         */
        function handleExport(format) {
            const filterType = exportFilterType.value;
            const filterValue = exportFilterValue.value;
            let notesToExport = [];

            if (filterType === 'all') {
                notesToExport = notes;
            } else if (filterType === 'tag') {
                notesToExport = notes.filter(note => note.tags && note.tags.includes(filterValue));
            } else if (filterType === 'contentItem') {
                notesToExport = notes.filter(note => note.contentItemId === filterValue);
            } else if (filterType === 'favorite') {
                notesToExport = notes.filter(note => note.isFavorite);
            } else if (filterType === 'standalone') {
                notesToExport = notes.filter(note => note.isStandalone);
            } else if (filterType === 'reviewDate') {
                notesToExport = notes.filter(note => note.reviewDate && new Date(note.reviewDate) >= new Date());
            }


            if (notesToExport.length === 0) {
                showMessageBox('No notes found for the selected filter.', 'info');
                return;
            }

            let fileContent;
            let fileName;

            if (format === 'json') {
                fileContent = JSON.stringify(notesToExport, null, 2);
                fileName = `smart_notepad_export_${filterType}.json`;
            } else { // txt
                fileContent = notesToExport.map(note => {
                    let text = `--- Note ID: ${note.id} ---\n`;
                    if (note.contentItemId) {
                        const contentItem = contentItems.find(item => item.id === note.contentItemId);
                        text += `Content: ${contentItem ? contentItem.title : 'Unknown Content'} (ID: ${note.contentItemId}, Type: ${contentItem ? contentItem.type : 'N/A'})\n`;
                        if (contentItem && contentItem.url) text += `URL: ${contentItem.url}\n`;
                    } else {
                        text += `Type: Standalone Note\n`;
                    }
                    if (note.timestamp) text += `Timestamp: ${formatTimestamp(note.timestamp)}\n`;
                    if (note.startSegment && note.endSegment) text += `Segment: ${formatTimestamp(note.startSegment)} - ${formatTimestamp(note.endSegment)}\n`;
                    if (note.intent) text += `Intent: ${note.intent}\n`;
                    if (note.priority) text += `Priority: ${note.priority.charAt(0).toUpperCase() + note.priority.slice(1)}\n`;
                    if (note.status) text += `Status: ${note.status.split('-').map(s => s.charAt(0).toUpperCase() + s.slice(1)).join(' ')}\n`;
                    if (note.estimatedDuration) text += `Estimated Duration: ${note.estimatedDuration} mins\n`;
                    if (note.reviewDate) text += `Review Date: ${new Date(note.reviewDate).toLocaleDateString()}\n`;
                    if (note.tags && note.tags.length > 0) text += `Tags: ${note.tags.map(t => `#${t}`).join(', ')}\n`;
                    if (note.isFavorite) text += `Favorite: Yes\n`;
                    text += `Created At: ${new Date(note.createdAt).toLocaleString()}\n`;
                    if (note.lastModifiedAt) text += `Last Modified At: ${new Date(note.lastModifiedAt).toLocaleString()}\n`;
                    text += `\n${note.content}\n\n`;
                    return text;
                }).join('\n');
                fileName = `smart_notepad_export_${filterType}.txt`;
            }

            const blob = new Blob([fileContent], { type: format === 'json' ? 'application/json' : 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showMessageBox('Notes exported successfully!', 'success');
        }

        // --- Event Listeners ---

        themeToggle.addEventListener('click', () => {
            const currentTheme = document.body.classList.contains('dark') ? 'dark' : 'light';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            localStorage.setItem('theme', newTheme);
            applyTheme();
        });

        addContentItemBtn.addEventListener('click', () => showView('addContentItem')); // Renamed
        addStandaloneNoteBtn.addEventListener('click', () => {
            selectedContentItem = null;
            editingNote = null;
            isStandaloneNote = true;
            showView('addNote'); // This will now show the form in the main dashboard view
        });
        showAllTagsBtn.addEventListener('click', () => showView('allTags'));
        showInsightsBtn.addEventListener('click', () => showView('insights'));
        showExportBtn.addEventListener('click', () => showView('export'));

        // New back buttons for utility panels
        backFromAllTagsBtn.addEventListener('click', () => showView('dashboard'));
        backFromInsightsBtn.addEventListener('click', () => showView('dashboard'));
        backFromExportBtn.addEventListener('click', () => showView('dashboard'));


        // Handle content type selection to show/hide URL input
        contentTypeSelect.addEventListener('change', () => {
            if (contentTypeSelect.value === 'text-only') {
                contentUrlGroup.classList.add('hidden');
                contentUrlInput.value = ''; // Clear URL if text-only
            } else {
                contentUrlGroup.classList.remove('hidden');
            }
        });

        saveContentItemBtn.addEventListener('click', () => {
            const type = contentTypeSelect.value;
            const url = contentUrlInput.value.trim();
            const title = contentTitleInput.value.trim();

            if (!title) {
                showMessageBox('Please provide a title for your content.', 'error');
                return;
            }
            if (type !== 'text-only' && !url) {
                showMessageBox('Please provide a URL for this content type.', 'error');
                return;
            }

            let youtubeId = null;
            if (type === 'youtube') {
                youtubeId = extractYouTubeVideoId(url);
                if (!youtubeId) {
                    showMessageBox('Invalid YouTube URL. Please enter a valid link.', 'error');
                    return;
                }
            }

            const newItem = {
                id: Date.now().toString(), // Simple unique ID
                type: type,
                url: url,
                title: title,
                youtubeId: youtubeId, // Will be null for non-YouTube types
                // Corrected YouTube thumbnail URL
                thumbnail: type === 'youtube' ? `https://img.youtube.com/vi/${youtubeId}/hqdefault.jpg` : null, // Generic thumbnail for YouTube
                createdAt: Date.now()
            };
            contentItems.push(newItem);
            saveData();
            showMessageBox('Content added successfully!', 'success');
            showView('dashboard');
        });

        cancelAddContentItemBtn.addEventListener('click', () => showView('dashboard'));

        backToDashboardBtn.addEventListener('click', () => {
            selectedContentItem = null;
            filterTag = ''; // Clear filter when going back to dashboard
            showView('dashboard');
        });

        // Global map to store delete button timeouts
        const deleteConfirmationTimeouts = new Map();

        // Event delegation for dynamically created elements
        document.addEventListener('click', (e) => {
            // View Notes button
            if (e.target.classList.contains('view-notes-btn')) {
                const contentItemId = e.target.dataset.contentItemId;
                selectedContentItem = contentItems.find(item => item.id === contentItemId);
                filterTag = ''; // Clear any existing tag filter
                showView('contentItemNotes');
            }
            // Add Note for Content Item button (from dashboard card)
            else if (e.target.classList.contains('add-note-for-content-item-btn')) {
                const contentItemId = e.target.dataset.contentItemId;
                selectedContentItem = contentItems.find(item => item.id === contentItemId);
                editingNote = null;
                isStandaloneNote = false;
                showView('addNote'); // Now correctly switches to addNote view
            }
            // Edit Note button
            const editButton = e.target.closest('.edit-note-btn');
            if (editButton) {
                const noteId = editButton.dataset.noteId;
                console.log('Edit button clicked for noteId:', noteId); // Debugging
                editingNote = notes.find(n => n.id === noteId);
                isStandaloneNote = editingNote.isStandalone;
                selectedContentItem = contentItems.find(item => item.id === editingNote.contentItemId); // Re-select content item if it's a linked note
                // If it's a standalone note, switch view; otherwise, just show the form
                if (isStandaloneNote) {
                    showView('addNote');
                } else {
                    showView('addNote'); // Now correctly switches to addNote view for linked notes too
                }
            }
            // Delete Note button
            const deleteButton = e.target.closest('.delete-note-btn');
            if (deleteButton) {
                const noteId = deleteButton.dataset.noteId;
                console.log('Delete button clicked for noteId:', noteId); // Debugging

                // If already in confirmation state
                if (deleteButton.dataset.confirmDelete === 'true') {
                    // Perform deletion
                    notes = notes.filter(n => n.id !== noteId);
                    saveData();
                    showMessageBox('Note deleted successfully!', 'success');
                    // Clear timeout and reset button immediately
                    clearTimeout(deleteConfirmationTimeouts.get(noteId));
                    deleteConfirmationTimeouts.delete(noteId);
                    
                    // Revert button to original state
                    deleteButton.innerHTML = deleteButton.dataset.originalHtml; // Revert to original icon
                    deleteButton.classList.remove('bg-red-600', 'text-white'); // Remove temporary style
                    deleteButton.dataset.confirmDelete = 'false';

                    // Re-render appropriate view
                    if (currentView === 'dashboard') {
                        renderDashboard();
                    } else if (currentView === 'contentItemNotes') {
                        renderContentItemNotes();
                    } else if (currentView === 'allTags') {
                        renderAllTags();
                    }
                } else {
                    // First click: enter confirmation state
                    deleteButton.dataset.confirmDelete = 'true';
                    // Store original icon HTML (to restore later)
                    deleteButton.dataset.originalHtml = deleteButton.innerHTML; 
                    
                    deleteButton.innerHTML = `<span class="text-sm font-semibold">Confirm?</span>`; // Change to text
                    deleteButton.classList.add('bg-red-600', 'text-white'); // Add temporary style for visibility
                    showMessageBox('Click again to confirm deletion.', 'warning', 2000);

                    // Set a timeout to revert the button if not confirmed
                    const timeoutId = setTimeout(() => {
                        if (deleteButton.dataset.confirmDelete === 'true') { // Only revert if still in confirmation state
                            deleteButton.innerHTML = deleteButton.dataset.originalHtml; // Revert to original icon
                            deleteButton.classList.remove('bg-red-600', 'text-white');
                            deleteButton.dataset.confirmDelete = 'false';
                        }
                        deleteConfirmationTimeouts.delete(noteId); // Clean up timeout map
                    }, 3000); // 3 seconds to confirm

                    deleteConfirmationTimeouts.set(noteId, timeoutId);
                }
            }
            // Delete Content Item (Link) button
            const deleteContentItemButton = e.target.closest('.delete-content-item-btn');
            if (deleteContentItemButton) {
                const contentItemIdToDelete = deleteContentItemButton.dataset.contentItemId;
                console.log('Delete content item button clicked for ID:', contentItemIdToDelete);

                // If already in confirmation state
                if (deleteContentItemButton.dataset.confirmDelete === 'true') {
                    // Perform deletion
                    contentItems = contentItems.filter(item => item.id !== contentItemIdToDelete);
                    notes = notes.filter(note => note.contentItemId !== contentItemIdToDelete); // Also delete associated notes
                    saveData();
                    showMessageBox('Link and associated notes deleted successfully!', 'success');
                    // Clear timeout and reset button immediately
                    clearTimeout(deleteConfirmationTimeouts.get(contentItemIdToDelete));
                    deleteConfirmationTimeouts.delete(contentItemIdToDelete);
                    
                    // Revert button to original state
                    deleteContentItemButton.innerHTML = deleteContentItemButton.dataset.originalHtml; // Revert to original icon
                    deleteContentItemButton.classList.remove('bg-red-600', 'text-white'); // Remove temporary style
                    deleteContentItemButton.dataset.confirmDelete = 'false';

                    renderDashboard(); // Re-render the dashboard
                } else {
                    // First click: enter confirmation state
                    deleteContentItemButton.dataset.confirmDelete = 'true';
                    // Store original icon HTML (to restore later)
                    deleteContentItemButton.dataset.originalHtml = deleteContentItemButton.innerHTML; 
                    
                    deleteContentItemButton.innerHTML = `<span class="text-sm font-semibold">Confirm?</span>`; // Change to text
                    deleteContentItemButton.classList.add('bg-red-600', 'text-white'); // Add temporary style for visibility
                    showMessageBox('Click again to confirm deletion of link and all its notes.', 'warning', 3000);

                    // Set a timeout to revert the button if not confirmed
                    const timeoutId = setTimeout(() => {
                        if (deleteContentItemButton.dataset.confirmDelete === 'true') { // Only revert if still in confirmation state
                            deleteContentItemButton.innerHTML = deleteContentItemButton.dataset.originalHtml; // Revert to original icon
                            deleteContentItemButton.classList.remove('bg-red-600', 'text-white');
                            deleteContentItemButton.dataset.confirmDelete = 'false';
                        }
                        deleteConfirmationTimeouts.delete(contentItemIdToDelete); // Clean up timeout map
                    }, 3000); // 3 seconds to confirm

                    deleteConfirmationTimeouts.set(contentItemIdToDelete, timeoutId);
                }
            }
            // Tag pill click for filtering
            else if (e.target.classList.contains('tag-pill') && e.target.dataset.tag) {
                filterTag = e.target.dataset.tag;
                if (currentView === 'dashboard' || currentView === 'allTags') {
                    showView('dashboard'); // Go to dashboard and apply filter
                } else if (currentView === 'contentItemNotes') {
                    renderContentItemNotes(); // Re-render content item notes with filter
                }
            }
            // Removed Focus Mode button click listener
            /*
            else if (e.target.classList.contains('focus-note-btn')) {
                const noteId = e.target.dataset.noteId;
                enterFocusMode(noteId);
            }
            */
            // Quiz Me button (Removed - keeping for reference if user asks to re-add)
            /*
            else if (e.target.classList.contains('quiz-note-btn')) {
                const noteId = e.target.dataset.noteId;
                const noteToQuiz = notes.find(n => n.id === noteId);
                if (noteToQuiz) {
                    startQuizMode([noteToQuiz]); // Quiz on just this note
                }
            }
            */
            // Toggle "See more/Show less" for titles
            else if (e.target.classList.contains('toggle-title-btn')) {
                const btn = e.target;
                const truncatedSpan = btn.previousElementSibling; // Span with "..."
                const fullSpan = truncatedSpan.previousElementSibling; // Span with full title (hidden)

                if (btn.textContent === 'See more') {
                    fullSpan.classList.remove('hidden');
                    truncatedSpan.classList.add('hidden');
                    btn.textContent = 'Show less';
                } else {
                    truncatedSpan.classList.remove('hidden');
                    fullSpan.classList.add('hidden');
                    btn.textContent = 'See more';
                }
            }
        });

        // Add Note for Content Item button (from content notes view)
        addNoteForContentItemBtnView.addEventListener('click', () => {
            editingNote = null;
            isStandaloneNote = false; // This button is for linked notes
            showView('addNote'); // Now correctly switches to addNote view
        });

        saveNoteBtn.addEventListener('click', () => {
            const content = noteContentTextarea.value.trim();
            const tags = noteTagsInput.value.split(',').map(tag => tag.trim()).filter(tag => tag !== '');
            const timestamp = parseTimestamp(noteTimestampInput.value);
            const startSegment = parseTimestamp(noteStartSegmentInput.value);
            const endSegment = parseTimestamp(noteEndSegmentInput.value);
            const isFavorite = noteFavoriteCheckbox.checked;
            const intent = noteIntentInput.value.trim();
            const priority = notePrioritySelect.value; // New
            const status = noteStatusSelect.value;     // New
            const estimatedDuration = parseInt(noteDurationInput.value.trim());
            const reviewDate = noteReviewDateInput.value; //ISO-MM-DD format

            if (!content) {
                showMessageBox('Note content cannot be empty.', 'error');
                return;
            }

            const now = Date.now();
            if (editingNote) {
                // Update existing note
                editingNote.content = content;
                editingNote.tags = tags;
                editingNote.timestamp = timestamp;
                editingNote.startSegment = startSegment;
                editingNote.endSegment = endSegment;
                editingNote.isFavorite = isFavorite;
                editingNote.intent = intent;
                editingNote.priority = priority; // New
                editingNote.status = status;     // New
                editingNote.estimatedDuration = isNaN(estimatedDuration) ? null : estimatedDuration;
                editingNote.reviewDate = reviewDate || null;
                editingNote.lastModifiedAt = now; // Update last modified timestamp
            } else {
                // Create new note
                const newNote = {
                    id: now.toString(), // Unique ID
                    content: content,
                    tags: tags,
                    timestamp: timestamp,
                    startSegment: startSegment,
                    endSegment: endSegment,
                    isFavorite: isFavorite,
                    isStandalone: isStandaloneNote,
                    contentItemId: selectedContentItem ? selectedContentItem.id : null, // Renamed from videoId
                    intent: intent,
                    priority: priority, // New
                    status: status,     // New
                    estimatedDuration: isNaN(estimatedDuration) ? null : estimatedDuration,
                    reviewDate: reviewDate || null,
                    createdAt: now,
                    lastModifiedAt: now
                };
                notes.push(newNote);

                // Update streak counter if a note was added today
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const lastDate = lastNoteCreationDate ? new Date(parseInt(lastNoteCreationDate)) : null;
                if (lastDate) lastDate.setHours(0, 0, 0, 0);

                if (!lastDate || (today.getTime() - lastDate.getTime()) / (1000 * 60 * 60 * 24) === 1) { // If no previous note or note was created yesterday
                    streakCount++;
                } else if (today.getTime() !== lastDate.getTime()) { // If note created today but not consecutive
                    streakCount = 1;
                }
                lastNoteCreationDate = today.getTime().toString();
            }

            saveData();
            showMessageBox(editingNote ? 'Note updated successfully!' : 'Note added successfully!', 'success');
            editingNote = null; // Clear editing state
            addEditNoteView.classList.add('hidden'); // Hide the form after saving

            if (isStandaloneNote) {
                showView('dashboard'); // Back to dashboard for standalone notes
            } else {
                renderContentItemNotes(); // Re-render content item notes for linked notes
            }
        });

        cancelAddEditNoteBtn.addEventListener('click', () => {
            editingNote = null; // Clear editing state
            addEditNoteView.classList.add('hidden'); // Hide the form after canceling

            if (isStandaloneNote) {
                showView('dashboard'); // Back to dashboard for standalone notes
            } else {
                // For linked notes, just hide the form, stay on the content item notes view
                // No need to call renderContentItemNotes() as data hasn't changed
            }
        });

        // Removed Focus Mode Event Listeners
        // closeFocusModeBtn.addEventListener('click', exitFocusMode);

        // Quiz Mode Event Listeners (Removed)
        /*
        closeQuizModeBtn.addEventListener('click', exitQuizMode);
        revealAnswerBtn.addEventListener('click', () => {
            quizAnswer.classList.remove('hidden');
            revealAnswerBtn.textContent = 'Answer Revealed';
        });
        nextQuizBtn.addEventListener('click', () => {
            currentQuizNoteIndex++;
            if (currentQuizNoteIndex < quizNotes.length) {
                displayQuizNote();
            } else {
                showMessageBox('Quiz session finished!', 'info');
                exitQuizMode();
            }
        });
        */

        // Tag Suggestions
        noteTagsInput.addEventListener('input', handleTagInput);
        noteTagsInput.addEventListener('blur', () => {
            // Delay hiding to allow click on suggestion
            setTimeout(() => tagSuggestionsContainer.classList.add('hidden'), 100);
        });
        noteTagsInput.addEventListener('focus', handleTagInput); // Show suggestions on focus if text exists

        // Export Panel Event Listeners
        exportFilterType.addEventListener('change', populateExportFilterValues);
        exportTxtBtn.addEventListener('click', () => handleExport('txt'));
        exportJsonBtn.addEventListener('click', () => handleExport('json'));


        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            updateStreakCounter(); // Initialize streak display on load
            showView('dashboard'); // Start on the dashboard view
        });

    </script>
</body>
</html>
